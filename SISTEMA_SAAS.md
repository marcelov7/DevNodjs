# üè¢ Sistema SaaS Multi-Tenant - Gest√£o de Equipamentos

## üöÄ Vis√£o Geral

Sistema transformado em **SaaS (Software as a Service)** com arquitetura **multi-tenant** que permite m√∫ltiplas organiza√ß√µes utilizarem a mesma infraestrutura com **isolamento completo de dados**.

## üèóÔ∏è Arquitetura Multi-Tenant

### **Abordagem H√≠brida Escalon√°vel**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SINGLE DATABASE                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Tenant 1        ‚îÇ  Tenant 2        ‚îÇ  Tenant 3            ‚îÇ
‚îÇ  (Empresa A)     ‚îÇ  (Empresa B)     ‚îÇ  (Empresa C)         ‚îÇ
‚îÇ                  ‚îÇ                  ‚îÇ                      ‚îÇ
‚îÇ  usuarios        ‚îÇ  usuarios        ‚îÇ  usuarios            ‚îÇ
‚îÇ  tenant_id: 1    ‚îÇ  tenant_id: 2    ‚îÇ  tenant_id: 3        ‚îÇ
‚îÇ                  ‚îÇ                  ‚îÇ                      ‚îÇ
‚îÇ  relatorios      ‚îÇ  relatorios      ‚îÇ  relatorios          ‚îÇ
‚îÇ  tenant_id: 1    ‚îÇ  tenant_id: 2    ‚îÇ  tenant_id: 3        ‚îÇ
‚îÇ                  ‚îÇ                  ‚îÇ                      ‚îÇ
‚îÇ  equipamentos    ‚îÇ  equipamentos    ‚îÇ  equipamentos        ‚îÇ
‚îÇ  tenant_id: 1    ‚îÇ  tenant_id: 2    ‚îÇ  tenant_id: 3        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Vantagens da Abordagem**

‚úÖ **Shared Database, Shared Schema com tenant_id**
- ‚úÖ Implementa√ß√£o simples e r√°pida
- ‚úÖ Menor custo de infraestrutura
- ‚úÖ Facilidade de manuten√ß√£o
- ‚úÖ Backup e restore simplificados
- ‚úÖ Escalabilidade horizontal

‚úÖ **Isolamento Garantido**
- üîê Middleware obrigat√≥rio em todas as rotas
- üîê Queries autom√°ticas com tenant_id
- üîê Valida√ß√£o de organiza√ß√£o ativa
- üîê Auditoria completa de a√ß√µes

## üìä Estrutura do Banco de Dados

### **Tabela Principal: `organizacoes`**

```sql
CREATE TABLE organizacoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(200) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    cnpj VARCHAR(20) UNIQUE,
    email_contato VARCHAR(100) NOT NULL,
    telefone VARCHAR(20),
    endereco TEXT,
    
    -- Configura√ß√µes do plano
    plano ENUM('basico', 'profissional', 'empresarial', 'enterprise') DEFAULT 'basico',
    max_usuarios INT DEFAULT 10,
    max_relatorios_mes INT DEFAULT 100,
    max_equipamentos INT DEFAULT 50,
    
    -- Recursos dispon√≠veis
    recursos_habilitados JSON DEFAULT ('["relatorios", "equipamentos", "usuarios"]'),
    
    -- Status e controle
    ativo BOOLEAN DEFAULT TRUE,
    suspenso BOOLEAN DEFAULT FALSE,
    motivo_suspensao TEXT DEFAULT NULL,
    data_vencimento DATE DEFAULT NULL,
    
    -- Metadados
    configuracoes JSON DEFAULT NULL,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### **tenant_id em Todas as Tabelas**

```sql
-- Exemplos de tabelas com tenant_id
ALTER TABLE usuarios ADD COLUMN tenant_id INT DEFAULT 1;
ALTER TABLE relatorios ADD COLUMN tenant_id INT DEFAULT 1;
ALTER TABLE equipamentos ADD COLUMN tenant_id INT DEFAULT 1;
ALTER TABLE locais ADD COLUMN tenant_id INT DEFAULT 1;
ALTER TABLE notificacoes ADD COLUMN tenant_id INT DEFAULT 1;
```

### **Tabelas de Suporte**

#### **Convites de Usu√°rios**
```sql
CREATE TABLE usuario_convites (
    id INT PRIMARY KEY AUTO_INCREMENT,
    tenant_id INT NOT NULL,
    email VARCHAR(100) NOT NULL,
    token VARCHAR(100) UNIQUE NOT NULL,
    nivel_acesso ENUM('admin', 'usuario', 'visitante') DEFAULT 'usuario',
    convidado_por INT NOT NULL,
    usado BOOLEAN DEFAULT FALSE,
    data_expiracao TIMESTAMP NOT NULL,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **Auditoria Completa**
```sql
CREATE TABLE auditoria_tenant (
    id INT PRIMARY KEY AUTO_INCREMENT,
    tenant_id INT NOT NULL,
    usuario_id INT DEFAULT NULL,
    acao VARCHAR(100) NOT NULL,
    entidade VARCHAR(50) NOT NULL,
    entidade_id INT DEFAULT NULL,
    dados_anteriores JSON DEFAULT NULL,
    dados_novos JSON DEFAULT NULL,
    ip_address VARCHAR(45) DEFAULT NULL,
    user_agent TEXT DEFAULT NULL,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## üîß Planos e Limites

### **Planos Dispon√≠veis**

| Plano | Usu√°rios | Relat√≥rios/M√™s | Equipamentos | Pre√ßo Sugerido |
|-------|----------|-----------------|---------------|----------------|
| **B√°sico** | 5 | 50 | 25 | R$ 99/m√™s |
| **Profissional** | 15 | 200 | 100 | R$ 299/m√™s |
| **Empresarial** | 50 | 1.000 | 500 | R$ 999/m√™s |
| **Enterprise** | 999 | 9.999 | 999 | R$ 2.999/m√™s |

### **Recursos por Plano**

```json
{
    "basico": ["relatorios", "equipamentos", "usuarios"],
    "profissional": ["relatorios", "equipamentos", "usuarios", "notificacoes"],
    "empresarial": ["relatorios", "equipamentos", "usuarios", "notificacoes", "api"],
    "enterprise": ["relatorios", "equipamentos", "usuarios", "notificacoes", "api", "webhook", "auditoria"]
}
```

## üõ°Ô∏è Seguran√ßa e Isolamento

### **Middleware de Tenant**

```javascript
// Extra√ß√£o autom√°tica de tenant
const extractTenant = async (req, res, next) => {
    // 1. Do usu√°rio autenticado
    if (req.user && req.user.tenant_id) {
        req.tenant_id = req.user.tenant_id;
    }
    // 2. Do header X-Tenant-ID
    else if (req.get('X-Tenant-ID')) {
        req.tenant_id = parseInt(req.get('X-Tenant-ID'));
    }
    // 3. Do subdomain
    else if (req.hostname !== 'localhost') {
        const subdomain = req.hostname.split('.')[0];
        const [org] = await query('SELECT id FROM organizacoes WHERE slug = ?', [subdomain]);
        if (org) req.tenant_id = org.id;
    }
    
    // Validar organiza√ß√£o ativa
    // ...
};
```

### **Verifica√ß√£o de Limites**

```javascript
const checkPlanLimits = (resource) => {
    return async (req, res, next) => {
        const { max_usuarios, max_relatorios_mes, max_equipamentos } = req.organizacao;
        
        // Verificar limite baseado no recurso
        let currentCount = await getCurrentResourceCount(req.tenant_id, resource);
        let limit = getResourceLimit(req.organizacao.plano, resource);
        
        if (currentCount >= limit) {
            return res.status(403).json({
                success: false,
                message: `Limite do plano atingido para ${resource}`,
                data: { current: currentCount, limit: limit }
            });
        }
        
        next();
    };
};
```

### **Queries Autom√°ticas com Tenant**

```javascript
// Fun√ß√£o helper para adicionar tenant_id automaticamente
const tenantQuery = async (sql, params = [], tenantId) => {
    if (!sql.includes('tenant_id') && tenantId) {
        sql = addTenantToQuery(sql, tenantId);
    }
    return query(sql, params);
};

// Exemplo de uso
const relatorios = await tenantQuery(
    'SELECT * FROM relatorios WHERE status = ?',
    ['pendente'],
    req.tenant_id
);
// Resultado: SELECT * FROM relatorios WHERE status = ? AND tenant_id = 1
```

## üîå APIs SaaS

### **Organiza√ß√µes**

```bash
# Listar organiza√ß√µes (admin_master)
GET /api/organizacoes

# Criar organiza√ß√£o (admin_master)
POST /api/organizacoes
{
    "nome": "Empresa ABC",
    "slug": "empresa-abc",
    "cnpj": "12.345.678/0001-90",
    "email_contato": "admin@empresa-abc.com",
    "plano": "profissional"
}

# Organiza√ß√£o atual
GET /api/organizacoes/current

# Estat√≠sticas da organiza√ß√£o
GET /api/organizacoes/:id/stats

# Suspender organiza√ß√£o (admin_master)
POST /api/organizacoes/:id/suspend
{
    "motivo": "Inadimpl√™ncia"
}
```

### **Convites de Usu√°rios**

```bash
# Convidar usu√°rio
POST /api/organizacoes/invite-user
{
    "email": "usuario@empresa.com",
    "nivel_acesso": "usuario"
}

# Aceitar convite
POST /api/auth/accept-invite
{
    "token": "abc123...",
    "nome": "Nome do Usu√°rio",
    "senha": "senha123"
}
```

## üöÄ Migra√ß√£o para SaaS

### **Script de Migra√ß√£o**

```bash
# Executar migra√ß√£o completa
node server/scripts/migrate-to-saas.js

# Ou apenas criar schema
node server/scripts/create-saas-schema.js
```

### **Passos da Migra√ß√£o**

1. ‚úÖ **Backup do banco de dados**
2. ‚úÖ **Criar tabela de organiza√ß√µes**
3. ‚úÖ **Adicionar tenant_id em todas as tabelas**
4. ‚úÖ **Criar organiza√ß√£o padr√£o (ID: 1)**
5. ‚úÖ **Migrar dados existentes para tenant_id = 1**
6. ‚úÖ **Criar tabelas de suporte (convites, auditoria)**
7. ‚úÖ **Criar views otimizadas**
8. ‚úÖ **Implementar triggers de auditoria**

### **Compatibilidade com Sistema Existente**

‚úÖ **Migra√ß√£o Zero-Downtime**
- Todos os dados existentes preservados
- Usu√°rios continuam funcionando normalmente
- tenant_id padr√£o (1) para dados existentes
- Backward compatibility completa

## üéØ Recursos Avan√ßados

### **1. Subdomain Routing**

```bash
# Acesso por subdomain
https://empresa-abc.seudominio.com
https://empresa-xyz.seudominio.com

# DNS Wildcard necess√°rio
*.seudominio.com -> seu_servidor_ip
```

### **2. API Keys por Organiza√ß√£o**

```javascript
// Gerar API key √∫nica por organiza√ß√£o
const apiKey = crypto.randomBytes(32).toString('hex');
await query('UPDATE organizacoes SET api_key = ? WHERE id = ?', [apiKey, tenantId]);
```

### **3. Webhooks Configur√°veis**

```javascript
// Notificar via webhook quando relat√≥rio for criado
if (organizacao.webhook_url) {
    await fetch(organizacao.webhook_url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            event: 'relatorio.criado',
            data: relatorio,
            tenant_id: req.tenant_id
        })
    });
}
```

### **4. Auditoria Completa**

```javascript
// Auditoria autom√°tica via middleware
app.use('/api/relatorios', auditAction('RELATORIO', 'relatorios'));

// Log de toda a√ß√£o importante
{
    "tenant_id": 1,
    "usuario_id": 5,
    "acao": "CRIAR_RELATORIO",
    "entidade": "relatorios",
    "entidade_id": 123,
    "dados_novos": { "titulo": "Problema no motor X" },
    "ip_address": "192.168.1.100",
    "data_criacao": "2024-01-15T10:30:00Z"
}
```

## üìà Escalabilidade e Performance

### **√çndices Otimizados**

```sql
-- √çndices para performance em consultas multi-tenant
CREATE INDEX idx_tenant_usuario ON usuarios(tenant_id, id);
CREATE INDEX idx_tenant_relatorio ON relatorios(tenant_id, data_criacao);
CREATE INDEX idx_tenant_equipamento ON equipamentos(tenant_id, ativo);
CREATE INDEX idx_auditoria_tenant_data ON auditoria_tenant(tenant_id, data_criacao);
```

### **Views para Consultas Complexas**

```sql
CREATE VIEW vw_relatorios_completos AS
SELECT 
    r.*,
    u.nome as usuario_nome,
    l.nome as local_nome,
    e.nome as equipamento_nome,
    o.nome as organizacao_nome,
    o.slug as organizacao_slug
FROM relatorios r
JOIN usuarios u ON r.usuario_id = u.id AND r.tenant_id = u.tenant_id
JOIN locais l ON r.local_id = l.id AND r.tenant_id = l.tenant_id
JOIN equipamentos e ON r.equipamento_id = e.id AND r.tenant_id = e.tenant_id
JOIN organizacoes o ON r.tenant_id = o.id
WHERE o.ativo = TRUE AND NOT o.suspenso;
```

### **Monitoramento e M√©tricas**

```javascript
// M√©tricas por organiza√ß√£o
app.get('/api/admin/metrics', adminMaster, async (req, res) => {
    const metrics = await query(`
        SELECT 
            o.nome,
            o.plano,
            COUNT(DISTINCT u.id) as usuarios_ativos,
            COUNT(DISTINCT r.id) as total_relatorios,
            COUNT(DISTINCT e.id) as total_equipamentos
        FROM organizacoes o
        LEFT JOIN usuarios u ON o.id = u.tenant_id AND u.ativo = true
        LEFT JOIN relatorios r ON o.id = r.tenant_id
        LEFT JOIN equipamentos e ON o.id = e.tenant_id AND e.ativo = true
        WHERE o.ativo = true
        GROUP BY o.id
        ORDER BY usuarios_ativos DESC
    `);
    
    res.json({ success: true, data: metrics });
});
```

## üîÑ Evolu√ß√£o Futura

### **Fase 2: Database per Tenant (Grandes Clientes)**

Para clientes enterprise com grandes volumes:

```javascript
// Configura√ß√£o din√¢mica de conex√£o por tenant
const getDatabaseConfig = (tenantId) => {
    if (tenantId === 999) { // Cliente enterprise
        return {
            host: 'enterprise-db.com',
            database: `tenant_${tenantId}`,
            user: 'dedicated_user'
        };
    }
    return defaultConfig; // Shared database
};
```

### **Fase 3: Microservi√ßos**

- Separar por dom√≠nios (usuarios, relatorios, equipamentos)
- API Gateway com tenant routing
- Event-driven architecture

## üéâ Benef√≠cios do SaaS

### **Para o Provedor**

‚úÖ **Receita Recorrente**: Modelo de assinatura mensal
‚úÖ **Escalabilidade**: Uma infraestrutura para N clientes  
‚úÖ **Manuten√ß√£o Centralizada**: Deploy √∫nico para todos
‚úÖ **Recursos Otimizados**: Sharing de infraestrutura
‚úÖ **Analytics Centralizados**: Dados de todos os clientes

### **Para os Clientes**

‚úÖ **Menor Custo**: Sem infraestrutura pr√≥pria
‚úÖ **Atualiza√ß√µes Autom√°ticas**: Sempre na vers√£o mais recente
‚úÖ **Escalabilidade El√°stica**: Crescer conforme necess√°rio
‚úÖ **Suporte Especializado**: Equipe dedicada
‚úÖ **Seguran√ßa Empresarial**: Backups, monitoramento, etc.

---

## ‚úÖ Status: **SISTEMA SAAS PRONTO PARA PRODU√á√ÉO** üöÄ

**Implementa√ß√£o Completa:**
- üè¢ Multi-tenancy com isolamento total
- üîê Seguran√ßa robusta por organiza√ß√£o  
- üìä Planos e limites configur√°veis
- üë• Sistema de convites de usu√°rios
- üìà Auditoria completa de a√ß√µes
- üîß APIs para gerenciamento SaaS
- üì± Notifica√ß√µes push por tenant
- üöÄ Migra√ß√£o zero-downtime implementada 